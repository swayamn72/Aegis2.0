version: '3.8'

services:
  postgres:
    image: postgres:16.6
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: aegis
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Enterprise resource management
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

  # Enterprise LocalStack Configuration
  localstack:
    image: localstack/localstack:3.0  # Use stable version
    ports:
      - "4566:4566"
    environment:
      - SERVICES=dynamodb,s3
      - DEBUG=0  # Reduce logging overhead
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - PERSISTENCE=1  # Enable persistence
      - LOCALSTACK_HOST=localhost
      # Enterprise performance tuning
      - DYNAMODB_OPTIMIZE_DB_BEFORE_STARTUP=1
      - DYNAMODB_SHARE_DB=1
      - S3_SKIP_SIGNATURE_VALIDATION=1
    volumes:
      - "./localstack:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    # Enterprise resource allocation
    deploy:
      resources:
        limits:
          memory: 2G      # Generous memory for LocalStack
          cpus: '1.0'     # Dedicated CPU
        reservations:
          memory: 1G      # Minimum guaranteed memory
          cpus: '0.5'     # Minimum CPU
    # Enterprise health check strategy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 60s       # Less frequent checks
      timeout: 30s        # Longer timeout
      retries: 5          # More retries
      start_period: 120s  # Wait 2 minutes before first check
    restart: unless-stopped
    # Enterprise stability
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # DynamoDB Admin UI
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      - DYNAMO_ENDPOINT=http://localstack:4566
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    depends_on:
      localstack:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    restart: unless-stopped

volumes:
  postgres_data:
